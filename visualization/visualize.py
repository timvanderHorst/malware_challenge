import os

import matplotlib.pyplot as plt
import numpy as np
import seaborn as sns
def import_data(path):
    if os.path.exists(path + '.npz'):
        return np.load(path + '.npz')['arr_0']
    data = []
    with open(path, 'r') as f:
        l = f.readline()
        while l is not None and len(l) > 0:
            line = list(map(int, l.split(',')))
            data.append(np.array(line))
            l = f.readline()
    data = np.array(data)
    np.savez_compressed(path, data)
    return data

def visualize(dataset, ax, label, pos):
    split = 100
    freq = dataset.sum(axis=0)
    parts = np.array_split(freq, split)
    parts = list(map(lambda p: np.log10(sum(p)), parts))
    indices = np.array_split(np.arange(len(freq)), split)
    indices = list(map(min, indices))
    x_position = np.arange(len(indices))
    x_position = x_position + (0.8/3)*(pos-1)
    ax.bar(x_position, parts, width=0.8/3, label=label, tick_label=indices)
    ax.set_xticklabels(indices, rotation=90)

def compare():
    fig, axs = plt.subplots(nrows=2,ncols=1,figsize=(24, 16))
    benign = import_data('0_epochs/benign.dat')
    visualize(benign, axs[0], 'benign', 0)
    del benign
    malicious = import_data('0_epochs/malicious.dat')
    visualize(malicious, axs[0], 'malicious', 1)
    del malicious
    adversarial = import_data('0_epochs/adversarial.dat')
    visualize(adversarial, axs[0], 'adversarial', 2)
    axs[0].legend()
    axs[0].set_title("Frequency of API calls (binned by index)\n1-epoch DFGSM_K")
    axs[0].set_ylabel('Log(API call frequency)')
    axs[0].set_xlabel('API call index bin start')

    benign = import_data('50_epochs/benign.dat')
    visualize(benign, axs[1], 'benign', 0)
    del benign
    malicious = import_data('50_epochs/malicious.dat')
    visualize(malicious, axs[1], 'malicious', 1)
    del malicious
    adversarial = import_data('50_epochs/adversarial.dat')
    visualize(adversarial, axs[1], 'adversarial', 2)
    axs[1].legend()
    axs[1].set_title("Frequency of API calls (binned by index)\n50-epoch DFGSM_K")
    axs[1].set_ylabel('Log(API call frequency)')
    axs[1].set_xlabel('API call index bin start')
    plt.show()

if __name__ == '__main__':
    compare()